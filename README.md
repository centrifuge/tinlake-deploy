# Tinlake Deploy

Contains the scripts to deploy the [Tinlake contracts](https://github.com/centrifuge/tinlake]) to Ethereum mainnet or a testnet.

## Requirements

1. Tinlake is built and developed with  [dapp.tools](https://github.com/dapphub/dapptools) from DappHub. The deployments happen with bash scripts and the command-line tool `seth`. ! note: dapp.tools version has to be > 0.28.0.
2. On MacOS, install coreutils `brew install coreutils` (this package cotains `realpath`, a dependency used in the scripts).
3. On Linux, install `jq`, e. g. with `apt-get install jq`
3. Init/update git submodules: `git submodule update`

### Deploy Config File

For a deployment, a config file needs to be defined.

### Required Parameters

```json
{
  "ETH_RPC_URL": "<<RPC URL>>",
  "ETH_FROM": "<<ADDRESS>>",
  "TINLAKE_CURRENCY": "<<ADDRESS>>",
  "MAIN_DEPLOYER": "<<ADDRESS>>",
  "SENIOR_INTEREST_RATE": "<<NUMBER>>",
  "MAX_RESERVE": "<<NUMBER>>",
  "MAX_SENIOR_RATIO": "<<NUMBER>>",
  "MIN_SENIOR_RATIO": "<<NUMBER>>",
  "CHALLENGE_TIME": "<<NUMBER>>",
  "DISCOUNT_RATE": "<<NUMBER>>",
  "MEMBER_ADMIN": "<<ADDRESS>>",
  "POOL_ADMIN1": "<<ADDRESS>>",
  "POOL_ADMIN2": "<<ADDRESS>>",
  "POOL_ADMIN3": "<<ADDRESS>>",
  "POOL_ADMIN4": "<<ADDRESS>>",
  "POOL_ADMIN5": "<<ADDRESS>>",
  "AO_POOL_ADMIN": "<<ADDRESS>>",
  "ORACLE": "<<ADDRESS>>"
}
```

### NAV Feed

It is possible to use the Principal NAV Feed or the Creditline NAV Feed

You can either set:

```json
{
 "NAV_IMPLEMENTATION": "principal"
}
```

Or:

```json
{
 "NAV_IMPLEMENTATION": "creditline"
}
```

### Optional Parameters

```json
{
  "ETH_GAS": "<<NUMBER>>",
  "ETH_GAS_PRICE": "<<NUMBER>>",
  "ETH_PRIO_FEE": "<<NUMBER>>",
  "ETH_KEYSTORE": "<<DIR PATH>>",
  "ETH_PASSWORD": "<<FILE PATH>>",
  "GOVERNANCE": "<<ADDRESS>>",
  "JUNIOR_TOKEN_NAME":  "<<STRING>>",
  "JUNIOR_TOKEN_SYMBOL":"<<STRING>>",
  "SENIOR_TOKEN_NAME": "<<STRING>>",
  "SENIOR_TOKEN_SYMBOL": "<<STRING>>",
}
```

The config file can contain addresses for Fabs.  
`TINLAKE_CURRENCY` defines the stablecoin for the Tinlake. For example on mainnet this could be the `DAI` stablecoin or any other ERC20 contract.  
`MAIN_DEPLOYER` is a contract which deploys our factories with the create2 opcode.  The other parameters are default config parameters from `seth`  
`SENIOR_INTEREST_RATE`should follow ONE as 10^27 (ratePerSecond)  
`MAX_RESERVE` should follow ONE as 10^18  
`MAX_SENIOR_RATIO` should follow ONE as 10^27  
`MIN_SENIOR_RATIO` should follow ONE as 10^27  
`CHALLENGE_TIME` should be in seconds  
`DISCOUNT_RATE` should follow ONE as 10^27 (ratePerSecond) 
`SENIOR_TRANCHE_SYMBOL` string not longer then 6 chars  
`SENIOR_TRANCHE_SYMBOL` string not longer then 6 chars  

### Maker Parameters
```json
{
  "IS_MKR": true,
  "WIRE_CLERK": false,
  "MKR_MGR_FAB": "<<ADDRESS>>",
  "MKR_DAI": "<<ADDRESS>>",
  "MKR_DAI_JOIN": "<<ADDRESS>>",
  "MKR_VOW": "<<ADDRESS>>",
  "MKR_SPOTTER": "<<ADDRESS>>",
  "MKR_VAT": "<<ADDRESS>>",
  "MKR_JUG": "<<ADDRESS>>",
  "MKR_LIQ": "<<ADDRESS>>",
  "MKR_END": "<<ADDRESS>>",
  "MKR_MAT_BUFFER": "10000000000000000000000000"
}
```

## Deploy Contracts

### Build Contracts

```json
make build
```

### Deploy Contracts
For deploying the contracts execute the following script.

```bash
./bin/deploy.sh <<Optional: Path to config file>>
```
The default filepath of the configfile is: `./config_$(seth chain).json`
`seth chain` returns the name of the current chain based on the provided

## Local Test Deployment of Contracts

**1. Set env variables (Optional)**

Adjust `.env-example.sh`, and run `source env-example.sh`.

**2. Build contracts**
```json
make build
```

**3. Start your own local testnet. Run in a seperated terminal**

```bash
dapp testnet
```

**4. Generate Test Config File**

```bash
make test-config
```

This should generate a default config file at `./bin/config_unknown.json`. Modify that file if needed.

**5. Run deploy script**

```bash
make deploy
```
Starts the deploy script with autogenerated default test-config file.


## Docker-based Test Deployment of Contracts

**1. Build the docker image**

```bash
docker build -t centrifugeio/tinlake-deploy:latest .
```

**2. Run a docker container**

```bash
docker run --rm -p 8545:8545 centrifugeio/tinlake-deploy:latest
```

## Util Scripts

**Create Main Deployer**
```json
dapp create MainDeployer
```

### Verify Contracts
1. add env var with your etherscan API key `export ETHERSCAN_API_KEY=<<YOUR KEY>>`
2. Make sure you have addresses file This should generate a file at `./addresses_$(seth chain).json` in your deployments folder.
   The file is autogenerated during the deployment process.
3. run verification script
```bash
make verify
```
